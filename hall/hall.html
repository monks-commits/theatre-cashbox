<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Схема залу (каса)</title>
<link rel="stylesheet" href="../styles.css"/>

<style>
.hall-layout{display:flex;gap:24px}
.hall-left{flex:1}
.hall-sidebar{width:280px}
.hall-scroll{background:#e5e7eb;padding:12px;border-radius:16px;overflow-x:auto}
.seat{width:24px;height:24px;border-radius:6px;border:1px solid #d1d5db;
display:flex;align-items:center;justify-content:center;font-size:11px;cursor:pointer}
.seat--taken{background:#9ca3af;color:#fff;cursor:not-allowed}
.seat--selected{background:#2563eb;color:#fff}
.row{display:flex;gap:4px;margin-bottom:4px}
.row-label{width:22px;text-align:right;font-size:11px;color:#6b7280}
.section{margin-bottom:20px}
.section-title{text-align:center;color:#6b7280;margin:6px 0}
</style>
</head>

<body>
<h1>Схема залу (каса)</h1>

<div class="hall-layout">
<div class="hall-left">
<div class="hall-scroll" id="hall"></div>
</div>

<div class="hall-sidebar">
<h3>Обрані місця</h3>
<div id="summary">—</div>
<div id="sum">Сума: 0 грн</div>
<button id="sell" disabled>Перейти до продажу</button>
</div>
</div>

<script type="module">
import { getSoldSeats } from "../cashier/cashier.db.js";

const qs = new URLSearchParams(location.search);
const show = qs.get("show");

const prices = {
  parter: r => r<=6?200:r<=12?160:140,
  amphi: ()=>120,
  balcony: r=>r<=5?100:80,
  lodge: ()=>10
};

const selected = new Map();
const taken = new Set(await getSoldSeats(show));

function seat(key, price){
  const b=document.createElement("div");
  b.className="seat";
  b.textContent=key.split("-")[1];
  if(taken.has(key)){b.classList.add("seat--taken");return b}
  b.onclick=()=>{
    if(selected.has(key)){selected.delete(key);b.classList.remove("seat--selected")}
    else{selected.set(key,price);b.classList.add("seat--selected")}
    update();
  };
  return b;
}

function row(label,seats,makeKey,priceFn){
  const d=document.createElement("div");d.className="row";
  const l=document.createElement("div");l.className="row-label";l.textContent=label;
  d.appendChild(l);
  for(let i=1;i<=seats;i++)d.appendChild(seat(makeKey(i),priceFn(label)));
  return d;
}

const hall=document.getElementById("hall");

// ПАРТЕР
hall.append(title("ПАРТЕР"));
for(let r=1;r<=18;r++)
  hall.append(row(r,20,i=>`P${r}-M${i}`,prices.parter));

// ЛОЖИ
hall.append(title("ЛОЖІ"));
for(let i=1;i<=18;i++){
  const d=document.createElement("div");d.className="row";
  d.append("A",seat(`A0-M${i}`,10)," ",seat(`B0-M${i}`,10));
  hall.append(d);
}

// АМФІТЕАТР
hall.append(title("АМФІТЕАТР"));
for(let r=19;r<=23;r++)
  hall.append(row(r,22,i=>`A${r}-M${i}`,prices.amphi));

// БАЛКОН
hall.append(title("БАЛКОН"));
for(let r=1;r<=6;r++)
  hall.append(row(r,28,i=>`B${r}-M${i}`,prices.balcony));

function title(t){const d=document.createElement("div");d.className="section-title";d.textContent=t;return d}

function update(){
  document.getElementById("summary").textContent=[...selected.keys()].join(", ")||"—";
  const s=[...selected.values()].reduce((a,b)=>a+b,0);
  document.getElementById("sum").textContent="Сума: "+s+" грн";
  document.getElementById("sell").disabled=!selected.size;
}
</script>
</body>
</html>
