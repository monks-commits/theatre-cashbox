<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Схема залу (каса)</title>

  <link rel="stylesheet" href="../styles.css"/>

  <style>
    body{background:#f3f4f6}
    h1{margin-bottom:12px}

    .layout{display:flex;gap:24px;align-items:flex-start}
    .hall{flex:1;background:#e5e7eb;border-radius:16px;padding:16px}
    .side{width:320px;background:#fff;border-radius:16px;padding:16px}

    .section{margin-bottom:18px}
    .section h3{
      text-align:center;
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#6b7280;
      margin:6px 0;
    }

    .row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .row-label{width:26px;text-align:right;font-size:12px;color:#6b7280}

    .seats{display:flex;gap:4px;flex-wrap:nowrap}

    .seat{
      width:26px;height:26px;
      border-radius:6px;
      border:1px solid #d1d5db;
      background:#fff;
      font-size:11px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .seat.selected{
      background:#2563eb;
      color:#fff;
      border-color:#2563eb;
    }

    .seat.taken{
      background:#9ca3af;
      color:#fff;
      cursor:not-allowed;
    }

    .gap{margin-right:16px}

    .price{font-weight:700}

    button.primary{
      width:100%;
      padding:12px;
      border-radius:999px;
      border:0;
      background:#2563eb;
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }

    button.primary:disabled{
      background:#93c5fd;
      cursor:not-allowed;
    }
  </style>
</head>
<body>

<main class="main">
  <div class="container">
    <h1>Схема залу (каса)</h1>

    <div class="layout">
      <div class="hall" id="hall"></div>

      <aside class="side">
        <h3>Обрані місця</h3>
        <div id="selected">—</div>
        <div style="margin-top:8px">
          Сума: <span class="price" id="total">0</span> грн
        </div>

        <div style="height:16px"></div>

        <button class="primary" id="goSale" disabled>
          Перейти до продажу
        </button>
      </aside>
    </div>
  </div>
</main>

<script>
/* ===============================
   ПАРАМЕТРИ
================================ */
const params = new URLSearchParams(location.search);
const show = params.get("show") || "";
const role = params.get("role") || "cashier";

/* ===============================
   СТАН
================================ */
const selected = new Map();

/* ===============================
   ЗАВАНТАЖЕННЯ СХЕМИ
================================ */
fetch("../data/halls/shevchenko-big.json")
  .then(r => r.json())
  .then(renderHall)
  .catch(() => {
    document.getElementById("hall").innerHTML =
      "<b>❌ Не вдалося завантажити схему залу</b>";
  });

/* ===============================
   РЕНДЕР
================================ */
function renderHall(data){
  const hall = document.getElementById("hall");
  hall.innerHTML = "";

  renderParter(data.parter);
  renderAmphi(data.amphi);
  renderBalcony(data.balcony);
  renderLodges(data.lodges);

  updateSummary();
}

function renderParter(rows){
  const sec = section("Партер");
  rows.forEach(r=>{
    const row = rowLine(r.row);
    for(let i=1;i<=r.seats;i++){
      row.seats.appendChild(seatBtn(`P${r.row}-${i}`, i, r.price));
      if(i===10) row.seats.lastChild.classList.add("gap");
    }
    sec.appendChild(row.el);
  });
  hall.appendChild(sec);
}

function renderAmphi(rows){
  const sec = section("Амфітеатр");
  rows.forEach(r=>{
    const row = rowLine(r.row);
    for(let i=1;i<=r.left;i++){
      row.seats.appendChild(seatBtn(`A${r.row}-${i}`, i, r.price));
    }
    row.seats.appendChild(gap());
    for(let i=1;i<=r.right;i++){
      const num = i + r.left;
      row.seats.appendChild(seatBtn(`A${r.row}-${num}`, num, r.price));
    }
    sec.appendChild(row.el);
  });
  hall.appendChild(sec);
}

function renderBalcony(rows){
  const sec = section("Балкон");
  rows.forEach(r=>{
    const row = rowLine(r.row);
    for(let i=1;i<=r.seats;i++){
      row.seats.appendChild(seatBtn(`B${r.row}-${i}`, i, r.price));
      if(i===14) row.seats.lastChild.classList.add("gap");
    }
    sec.appendChild(row.el);
  });
  hall.appendChild(sec);
}

function renderLodges(l){
  const sec = section("Ложі");
  ["A","B"].forEach(letter=>{
    const row = rowLine(`Ложа ${letter}`);
    for(let i=1;i<=l.count;i++){
      row.seats.appendChild(
        seatBtn(`L${letter}-${i}`, i, l.price)
      );
    }
    sec.appendChild(row.el);
  });
  hall.appendChild(sec);
}

/* ===============================
   UI ЕЛЕМЕНТИ
================================ */
function section(title){
  const s = document.createElement("div");
  s.className = "section";
  s.innerHTML = `<h3>${title}</h3>`;
  return s;
}

function rowLine(label){
  const el = document.createElement("div");
  el.className = "row";
  const lab = document.createElement("div");
  lab.className = "row-label";
  lab.textContent = label;
  const seats = document.createElement("div");
  seats.className = "seats";
  el.append(lab,seats);
  return {el,seats};
}

function seatBtn(key,label,price){
  const b = document.createElement("button");
  b.className = "seat";
  b.textContent = label;
  b.onclick = ()=>{
    if(b.classList.contains("selected")){
      b.classList.remove("selected");
      selected.delete(key);
    }else{
      b.classList.add("selected");
      selected.set(key, price);
    }
    updateSummary();
  };
  return b;
}

function gap(){
  const d = document.createElement("div");
  d.style.width="26px";
  return d;
}

/* ===============================
   ПІДСУМОК
================================ */
function updateSummary(){
  const list = document.getElementById("selected");
  const totalEl = document.getElementById("total");
  const btn = document.getElementById("goSale");

  if(selected.size===0){
    list.textContent = "—";
    totalEl.textContent = "0";
    btn.disabled = true;
    return;
  }

  let sum = 0;
  list.innerHTML = "";
  selected.forEach((price,key)=>{
    sum += price;
    const d = document.createElement("div");
    d.textContent = key;
    list.appendChild(d);
  });

  totalEl.textContent = sum;
  btn.disabled = false;

  btn.onclick = ()=>{
    const seats = [...selected.keys()].join(",");
    location.href =
      `../cashier/sale.html?show=${show}&seats=${seats}&amount=${sum}`;
  };
}
</script>

</body>
</html>
