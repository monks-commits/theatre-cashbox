<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Схема залу (каса)</title>

  <link rel="stylesheet" href="../styles.css" />

  <style>
    body{background:#f3f4f6}
    h1{margin-bottom:12px}

    .layout{display:flex;gap:24px;align-items:flex-start}
    .hall{
      background:#e5e7eb;
      padding:16px;
      border-radius:16px;
      flex:1;
      overflow-x:auto;
    }
    .sidebar{
      width:300px;
      background:#fff;
      border-radius:16px;
      padding:16px;
    }

    .section{margin-bottom:24px}
    .section-title{
      text-align:center;
      font-weight:800;
      margin-bottom:8px;
      color:#374151;
    }

    .row{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
    }
    .row-label{
      width:24px;
      text-align:right;
      font-size:12px;
      color:#6b7280;
    }
    .seats{display:flex;gap:4px}

    .seat{
      width:26px;
      height:26px;
      border-radius:6px;
      border:1px solid #d1d5db;
      background:#fff;
      font-size:11px;
      cursor:pointer;
    }
    .seat.selected{
      background:#2563eb;
      color:#fff;
      border-color:#2563eb;
    }

    .seat.parter{background:#fef9c3}
    .seat.amphi{background:#e0f2fe}
    .seat.balcony{background:#f3e8ff}
    .seat.lodge{background:#fee2e2}

    button.primary{
      width:100%;
      margin-top:12px;
      padding:12px;
      border-radius:999px;
      border:none;
      background:#2563eb;
      color:#fff;
      font-weight:800;
      cursor:pointer;
    }
    button.primary:disabled{
      opacity:.4;
      cursor:not-allowed;
    }
  </style>
</head>
<body>

<main class="main">
  <div class="container">
    <h1>Схема залу (каса)</h1>

    <div class="layout">
      <div class="hall" id="hall"></div>

      <aside class="sidebar">
        <h2>Обрані місця</h2>
        <div id="chosen">—</div>
        <div style="margin-top:8px;font-weight:700">
          Сума: <span id="total">0</span> грн
        </div>
        <button id="goSale" class="primary" disabled>
          Перейти до продажу
        </button>
      </aside>
    </div>
  </div>
</main>

<script>
/* ============================
   НАСТРОЙКИ
============================ */
const HALL_JSON = "../data/halls/shevchenko-big.json";

/* ============================
   СОСТОЯНИЕ
============================ */
const selected = new Map();

/* ============================
   ЗАГРУЗКА СХЕМЫ
============================ */
async function loadHall(){
  const res = await fetch(HALL_JSON, {cache:"no-store"});
  if(!res.ok) throw new Error("hall json error");
  return await res.json();
}

/* ============================
   РЕНДЕР
============================ */
function renderSection(title, rows, zone, price, css){
  const wrap = document.createElement("div");
  wrap.className = "section";

  const h = document.createElement("div");
  h.className = "section-title";
  h.textContent = title;
  wrap.appendChild(h);

  rows.forEach(r=>{
    const row = document.createElement("div");
    row.className = "row";

    const label = document.createElement("div");
    label.className = "row-label";
    label.textContent = r.row ?? "";
    row.appendChild(label);

    const seats = document.createElement("div");
    seats.className = "seats";

    for(let i=1;i<=r.seats;i++){
      const b = document.createElement("button");
      b.className = `seat ${css}`;
      b.textContent = i;

      const key = `${zone}-${r.row}-${i}`;

      b.onclick = ()=>{
        if(selected.has(key)){
          selected.delete(key);
          b.classList.remove("selected");
        }else{
          selected.set(key,{
            zone, row:r.row, seat:i, price
          });
          b.classList.add("selected");
        }
        updateSummary();
      };

      seats.appendChild(b);
    }

    row.appendChild(seats);
    wrap.appendChild(row);
  });

  return wrap;
}

/* ============================
   СУММАРИЙ
============================ */
function updateSummary(){
  const list = document.getElementById("chosen");
  const total = document.getElementById("total");
  const btn = document.getElementById("goSale");

  if(selected.size===0){
    list.textContent="—";
    total.textContent="0";
    btn.disabled=true;
    return;
  }

  const items = [];
  let sum = 0;

  selected.forEach(v=>{
    items.push(`Ряд ${v.row}, місце ${v.seat} (${v.zone})`);
    sum += v.price;
  });

  list.textContent = items.join("; ");
  total.textContent = sum;
  btn.disabled=false;
}

/* ============================
   СТАРТ
============================ */
(async ()=>{
  try{
    const hall = await loadHall();
    const root = document.getElementById("hall");

    root.appendChild(
      renderSection(
        "Партер",
        hall.parter.rows,
        "Партер",
        200,
        "parter"
      )
    );

    if(hall.amphi){
      root.appendChild(
        renderSection(
          "Амфітеатр",
          hall.amphi.rows,
          "Амфітеатр",
          120,
          "amphi"
        )
      );
    }

    if(hall.balcony){
      root.appendChild(
        renderSection(
          "Балкон",
          hall.balcony.rows,
          "Балкон",
          100,
          "balcony"
        )
      );
    }

    if(hall.lodges){
      root.appendChild(
        renderSection(
          "Ложі",
          hall.lodges.rows,
          "Ложа",
          10,
          "lodge"
        )
      );
    }

  }catch(e){
    document.getElementById("hall").innerHTML =
      "❌ Не вдалося завантажити схему залу";
    console.error(e);
  }
})();

/* ============================
   ПЕРЕХОД К ПРОДАЖЕ
============================ */
document.getElementById("goSale").onclick = ()=>{
  const seats = [];
  let sum = 0;

  selected.forEach(v=>{
    seats.push(`${v.zone} ${v.row}-${v.seat}`);
    sum+=v.price;
  });

  const url = new URL("../cashier/sale.html", location.href);
  url.searchParams.set("seats", seats.join(", "));
  url.searchParams.set("amount", sum);

  location.href = url.toString();
};
</script>
</body>
</html>
