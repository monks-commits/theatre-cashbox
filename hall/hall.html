<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Схема залу (каса)</title>

<style>
/* ====== БАЗА ====== */
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,sans-serif;background:#f3f4f6;color:#111}
h1{margin:16px}

/* ====== ЛЭЙАУТ ====== */
.hall-layout{display:flex;gap:24px;align-items:flex-start;padding:16px}
.hall-left{flex:1}
.hall-sidebar{width:300px}
.card{background:#fff;border-radius:14px;padding:16px}

/* ====== СКРОЛЛ ====== */
.hall-scroll{background:#e5e7eb;border-radius:18px;padding:14px;overflow-x:auto}
.hall-inner{width:1100px}

/* ====== СЕКЦИИ ====== */
.hall-section{margin-bottom:18px}
.hall-section-title{text-align:center;font-size:14px;letter-spacing:.1em;color:#6b7280;margin:6px 0}

/* ====== РЯДЫ ====== */
.row-line{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.row-label{width:26px;text-align:right;font-size:11px;color:#6b7280}
.seats-row{display:flex;gap:4px}

/* ====== МЕСТА ====== */
.seat{
width:24px;height:24px;border-radius:6px;
border:1px solid #cbd5e1;background:#fff;
font-size:11px;cursor:pointer;
display:flex;align-items:center;justify-content:center
}
.seat--front{background:#fef9c3}
.seat--mid{background:#dbeafe}
.seat--back{background:#e5e7eb}
.seat--amphi{background:#e0f2fe}
.seat--balcony{background:#f3e8ff}
.seat--lodge{background:#fee2e2}

.seat--selected{background:#2563eb!important;color:#fff;border-color:#2563eb}
.seat--taken{background:#9ca3af!important;color:#fff;cursor:not-allowed}
.seat--gap{margin-right:18px}
.seat--empty{visibility:hidden;border:none}

/* ====== ЛОЖИ ====== */
.parter-wrap{display:flex;justify-content:center;gap:24px}
.hall-lodge{display:flex;flex-direction:column;align-items:center}
.hall-lodge-label{font-size:12px;color:#6b7280;margin-bottom:4px}
.hall-lodge-seats{display:flex;flex-direction:column;gap:4px}

/* ====== АМФИТЕАТР ====== */
.amphi-gap{width:28px}

/* ====== SIDEBAR ====== */
.button{width:100%;padding:10px;border-radius:10px;border:none;background:#2563eb;color:#fff;font-size:16px}
.button:disabled{background:#9ca3af}
.meta{font-size:14px;color:#374151;margin:6px 0}
</style>
</head>

<body>
<h1>Схема залу (каса)</h1>

<div class="hall-layout">
<div class="hall-left">
<div class="hall-scroll">
<div class="hall-inner">

<!-- ====== ПАРТЕР + ЛОЖИ ====== -->
<section class="hall-section">
<div class="hall-section-title">ПАРТЕР</div>

<div class="parter-wrap">

<!-- ЛОЖА А -->
<div class="hall-lodge">
<div class="hall-lodge-label">Ложа А</div>
<div class="hall-lodge-seats" id="lodgeA"></div>
</div>

<div id="parter"></div>

<!-- ЛОЖА Б -->
<div class="hall-lodge">
<div class="hall-lodge-label">Ложа Б</div>
<div class="hall-lodge-seats" id="lodgeB"></div>
</div>

</div>
</section>

<!-- ====== АМФИТЕАТР ====== -->
<section class="hall-section">
<div class="hall-section-title">АМФІТЕАТР</div>
<div id="amphi"></div>
</section>

<!-- ====== БАЛКОН ====== -->
<section class="hall-section">
<div class="hall-section-title">БАЛКОН</div>
<div id="balcony"></div>
</section>

</div>
</div>
</div>

<!-- ====== SIDEBAR ====== -->
<aside class="hall-sidebar">
<div class="card">
<h2>Обрані місця</h2>
<p id="places" class="meta">—</p>
<p id="amount" class="meta">Сума: 0 грн</p>
<button id="sell" class="button" disabled>Перейти до продажу</button>
</div>
</aside>
</div>

<script type="module">
import { getSoldSeats, createSale } from "../cashier/cashier.db.js";

const qs=new URLSearchParams(location.search);
const show=qs.get("show")||"default";

const taken=new Set(await getSoldSeats(show));
const selected=new Map();

function seatKey(z,r,s){return `${z}${r}-M${s}`}

function seat(btn,key,price){
if(taken.has(key)){btn.classList.add("seat--taken");btn.disabled=true;return}
btn.onclick=()=>{
if(btn.classList.toggle("seat--selected")){
selected.set(key,price)
}else selected.delete(key)
renderSummary()
}
}

function renderSummary(){
const p=[...selected.keys()];
document.getElementById("places").textContent=p.join(", ")||"—";
const sum=[...selected.values()].reduce((a,b)=>a+b,0);
document.getElementById("amount").textContent="Сума: "+sum+" грн";
document.getElementById("sell").disabled=!p.length;
}

/* ====== ПАРТЕР ====== */
const parter=document.getElementById("parter");
for(let r=1;r<=18;r++){
const line=document.createElement("div");line.className="row-line";
const lab=document.createElement("div");lab.className="row-label";lab.textContent=r;
const row=document.createElement("div");row.className="seats-row";
for(let s=1;s<=20;s++){
const b=document.createElement("button");b.className="seat "+
(r<=6?"seat--front":r<=12?"seat--mid":"seat--back")+(s===10?" seat--gap":"");
b.textContent=s;
const key=seatKey("P",r,s);
seat(b,key,r<=6?200:r<=12?160:140);
row.appendChild(b)
}
line.append(lab,row);parter.appendChild(line)
}

/* ====== ЛОЖИ ====== */
["A","B"].forEach((L,i)=>{
const box=document.getElementById(i?"lodgeB":"lodgeA");
for(let s=1;s<=18;s++){
const b=document.createElement("button");b.className="seat seat--lodge";b.textContent=s;
const key=seatKey(L,0,s);seat(b,key,10);box.appendChild(b)
}
});

/* ====== АМФИТЕАТР ====== */
const am=document.getElementById("amphi");
[19,20,21,22,23].forEach(r=>{
const line=document.createElement("div");line.className="row-line";
const lab=document.createElement("div");lab.className="row-label";lab.textContent=r;
const L=document.createElement("div");L.className="seats-row";
const gap=document.createElement("div");gap.className="amphi-gap";
const R=document.createElement("div");R.className="seats-row";
for(let s=1;s<=11;s++){const b=document.createElement("button");b.className="seat seat--amphi";b.textContent=s;seat(b,seatKey("A",r,s),120);L.appendChild(b)}
for(let s=12;s<=22;s++){const b=document.createElement("button");b.className="seat seat--amphi";b.textContent=s;seat(b,seatKey("A",r,s),120);R.appendChild(b)}
line.append(lab,L,gap,R);am.appendChild(line)
});

/* ====== БАЛКОН ====== */
const bal=document.getElementById("balcony");
for(let r=1;r<=6;r++){
const line=document.createElement("div");line.className="row-line";
const lab=document.createElement("div");lab.className="row-label";lab.textContent=r;
const row=document.createElement("div");row.className="seats-row";
for(let s=1;s<=28;s++){
if(r===6 && s>10 && s<19){const e=document.createElement("div");e.className="seat seat--empty";row.appendChild(e);continue}
const b=document.createElement("button");b.className="seat seat--balcony"+(s===14?" seat--gap":"");
b.textContent=r===6&&s>=19?s-8:s;
seat(b,seatKey("B",r,b.textContent),r<=5?100:80);row.appendChild(b)
}
line.append(lab,row);bal.appendChild(line)
}

/* ====== ПРОДАЖА ====== */
document.getElementById("sell").onclick=async()=>{
for(const [k,p] of selected){
await createSale({show_id:show,seat_label:k,price:p})
}
location.reload()
}
</script>
</body>
</html>
