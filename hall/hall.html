<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Схема залу (каса)</title>

  <link rel="stylesheet" href="../styles.css" />

  <style>
    .hall-layout{display:flex;gap:24px;align-items:flex-start;}
    .hall-left{flex:1 1 auto;min-width:0;}
    .hall-sidebar{width:280px;flex:0 0 280px;}
    .hall-card{margin-top:0;}

    .hall-scroll{
      background:#e5e7eb;border-radius:16px;padding:12px;
      overflow-x:auto;
    }
    .hall-inner{width:max(980px,100%);}

    .hall-section{margin-bottom:18px;}
    .hall-section-title{
      text-align:center;font-size:14px;text-transform:uppercase;
      letter-spacing:.08em;color:#6b7280;margin:4px 0 6px;
    }

    .row-line{display:flex;align-items:center;gap:8px;margin-bottom:4px;}
    .row-label{width:22px;text-align:right;font-size:11px;color:#6b7280;}
    .seats-row{display:flex;gap:4px;flex-wrap:nowrap;}

    .seat{
      width:24px;height:24px;border-radius:6px;
      border:1px solid #d1d5db;
      background:#fff;
      font-size:11px;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
    }

    .seat--parter-front{background:#fef9c3;}
    .seat--parter-mid{background:#dbeafe;}
    .seat--parter-back{background:#e5e7eb;}
    .seat--amphi{background:#e0f2fe;}
    .seat--balcony{background:#f3e8ff;}
    .seat--lodge{background:#fee2e2;}

    .seat--selected{background:#2563eb !important;color:#fff;border-color:#2563eb;}
    .seat--taken{background:#9ca3af !important;color:#fff;cursor:not-allowed;}

    .seat--gap-right{margin-right:16px;}
    .amphi-gap{width:24px;}

    .parter-wrap{display:flex;justify-content:center;gap:24px;}
    .hall-lodge{display:flex;flex-direction:column;align-items:center;gap:4px;}
    .hall-lodge-label{font-size:11px;color:#6b7280;}
    .hall-lodge-seats{display:flex;flex-direction:column;gap:4px;}

    .seat--empty{visibility:hidden;border:none;}

    @media (max-width:900px){
      .hall-layout{flex-direction:column;}
      .hall-sidebar{width:auto;}
    }
  </style>
</head>
<body>

<main class="main">
  <div class="container">
    <h1>Схема залу (каса)</h1>

    <div class="hall-layout">
      <div class="hall-left">
        <div class="hall-scroll">
          <div class="hall-inner">

            <!-- ПАРТЕР + ЛОЖІ -->
            <section class="hall-section">
              <div class="hall-section-title">Партер</div>

              <div class="parter-wrap">
                <div class="hall-lodge">
                  <div class="hall-lodge-label">Ложа А</div>
                  <div id="lodge-a-seats" class="hall-lodge-seats"></div>
                </div>

                <div id="parter-block"></div>

                <div class="hall-lodge">
                  <div class="hall-lodge-label">Ложа Б</div>
                  <div id="lodge-b-seats" class="hall-lodge-seats"></div>
                </div>
              </div>
            </section>

            <section class="hall-section">
              <div class="hall-section-title">Амфітеатр</div>
              <div id="amphi-block"></div>
            </section>

            <section class="hall-section">
              <div class="hall-section-title">Балкон</div>
              <div id="balcony-block"></div>
            </section>

          </div>
        </div>
      </div>

      <aside class="hall-sidebar">
        <div class="card hall-card">
          <h2>Обрані місця</h2>
          <p id="summary-places">—</p>
          <p id="summary-amount">Сума: 0 грн</p>
          <button id="go-sale" class="button-primary" disabled>Перейти до продажу</button>
        </div>
      </aside>
    </div>
  </div>
</main>

<script type="module">
  import { getSoldSeats, saveSale } from "../cashier/cashier.db.js";

  const qs = new URLSearchParams(location.search);
  const show = qs.get("show");
  if (!show) alert("Немає show");

  const sold = new Set(getSoldSeats(show));
  const selected = new Map();

  function seatKey(p,r,s){ return `${p}${r}-M${s}`; }

  function makeSeat(key,label,cls,price){
    const b=document.createElement("button");
    b.textContent=label;
    b.className="seat "+cls;
    if(sold.has(key)){
      b.classList.add("seat--taken");
      b.disabled=true;
    }
    b.onclick=()=>{
      if(b.classList.contains("seat--selected")){
        b.classList.remove("seat--selected");
        selected.delete(key);
      }else{
        b.classList.add("seat--selected");
        selected.set(key,price);
      }
      updateSummary();
    };
    return b;
  }

  function updateSummary(){
    const p=document.getElementById("summary-places");
    const a=document.getElementById("summary-amount");
    const b=document.getElementById("go-sale");

    if(!selected.size){
      p.textContent="—";
      a.textContent="Сума: 0 грн";
      b.disabled=true;
      return;
    }

    p.textContent=[...selected.keys()].join(", ");
    const sum=[...selected.values()].reduce((x,y)=>x+y,0);
    a.textContent=`Сума: ${sum} грн`;
    b.disabled=false;
  }

  function renderParter(){
    const block=document.getElementById("parter-block");
    for(let r=1;r<=18;r++){
      const line=document.createElement("div");
      line.className="row-line";
      line.innerHTML=`<div class="row-label">${r}</div>`;
      const row=document.createElement("div");
      row.className="seats-row";

      for(let s=1;s<=20;s++){
        const price=r<=6?200:r<=12?160:140;
        const cls=r<=6?"seat--parter-front":r<=12?"seat--parter-mid":"seat--parter-back";
        row.appendChild(makeSeat(seatKey("P",r,s),s,cls+(s===10?" seat--gap-right":""),price));
      }
      line.appendChild(row);
      block.appendChild(line);
    }
  }

  function renderLodges(){
    for(const side of [["A","lodge-a-seats"],["B","lodge-b-seats"]]){
      const el=document.getElementById(side[1]);
      for(let i=1;i<=18;i++){
        el.appendChild(makeSeat(seatKey(side[0],0,i),i,"seat--lodge",10));
      }
    }
  }

  function renderAmphi(){
    const b=document.getElementById("amphi-block");
    [19,20,21,22,23].forEach(r=>{
      const l=document.createElement("div");
      l.className="row-line";
      l.innerHTML=`<div class="row-label">${r}</div>`;
      const left=document.createElement("div");
      left.className="seats-row";
      const right=document.createElement("div");
      right.className="seats-row";

      for(let s=1;s<=11;s++)
        left.appendChild(makeSeat(seatKey("A",r,s),s,"seat--amphi",120));
      for(let s=12;s<=22;s++)
        right.appendChild(makeSeat(seatKey("A",r,s),s,"seat--amphi",120));

      l.append(left,document.createElement("div"),right);
      b.appendChild(l);
    });
  }

  function renderBalcony(){
    const b=document.getElementById("balcony-block");
    for(let r=1;r<=6;r++){
      const l=document.createElement("div");
      l.className="row-line";
      l.innerHTML=`<div class="row-label">${r}</div>`;
      const row=document.createElement("div");
      row.className="seats-row";
      for(let s=1;s<=28;s++){
        const price=r<=5?100:80;
        row.appendChild(makeSeat(seatKey("B",r,s),s,"seat--balcony",price));
      }
      l.appendChild(row);
      b.appendChild(l);
    }
  }

  document.getElementById("go-sale").onclick=()=>{
    const u=new URL("../cashier/sale.html",location.href);
    u.searchParams.set("show",show);
    u.searchParams.set("seats",[...selected.keys()].join(","));
    u.searchParams.set("amount",[...selected.values()].reduce((a,b)=>a+b,0));
    location.href=u;
  };

  renderParter();
  renderLodges();
  renderAmphi();
  renderBalcony();
</script>

</body>
</html>
