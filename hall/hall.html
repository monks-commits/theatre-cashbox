<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Схема залу (каса)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:system-ui;background:#f3f4f6}
h1{margin:16px}
.wrap{display:flex;gap:24px;padding:16px}
.hall{flex:1;background:#e5e7eb;border-radius:16px;padding:16px;overflow:auto}
.side{width:280px;background:#fff;border-radius:16px;padding:16px}

.section{margin:16px 0;text-align:center;color:#6b7280;font-size:13px;letter-spacing:.08em}

.parter-wrap{display:flex;justify-content:center;gap:24px}

.lodge{display:flex;flex-direction:column;gap:4px}
.lodge-title{font-size:12px;color:#6b7280;text-align:center;margin-bottom:4px}

.rows{display:flex;flex-direction:column;gap:4px}

.row{display:flex;align-items:center;gap:6px}
.row-label{width:22px;text-align:right;font-size:11px;color:#6b7280}

.seats{display:flex;gap:4px}

.seat{
  width:24px;height:24px;border-radius:6px;
  border:1px solid #d1d5db;
  font-size:11px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  background:#fff
}

.front{background:#fef9c3}
.mid{background:#dbeafe}
.back{background:#e5e7eb}
.amphi{background:#e0f2fe}
.balcony{background:#f3e8ff}
.lodge-seat{background:#fee2e2}

.sel{background:#2563eb!important;color:#fff}
.taken{background:#9ca3af!important;color:#fff;cursor:not-allowed}

.gap{margin-right:16px}
.center-gap{width:24px}

button.main{
  width:100%;padding:10px;border-radius:10px;
  border:0;background:#2563eb;color:#fff;font-size:14px
}
button.main:disabled{opacity:.4}
</style>
</head>

<body>
<h1>Схема залу (каса)</h1>

<div class="wrap">
  <div class="hall" id="hall"></div>

  <div class="side">
    <h3>Обрані місця</h3>
    <div id="list">—</div>
    <div id="sum">Сума: 0 грн</div><br>
    <button id="sell" class="main" disabled>Перейти до продажу</button>
  </div>
</div>

<script>
const qs=new URLSearchParams(location.search);
const show=qs.get("show")||"default";

/* ===== IndexedDB ===== */
const DB="cashbox",V=1;
let db;
function openDB(){
  if(db) return Promise.resolve(db);
  return new Promise(res=>{
    const r=indexedDB.open(DB,V);
    r.onupgradeneeded=e=>{
      e.target.result.createObjectStore("taken",{keyPath:"key"});
    };
    r.onsuccess=()=>res(db=r.result);
  });
}
async function getTaken(){
  const d=await openDB();
  return new Promise(res=>{
    const r=d.transaction("taken").objectStore("taken").getAll();
    r.onsuccess=()=>res(
      r.result.filter(x=>x.show===show).map(x=>x.seat)
    );
  });
}
async function saveTaken(seat){
  const d=await openDB();
  d.transaction("taken","readwrite")
   .objectStore("taken")
   .put({key:show+"|"+seat,show,seat});
}

/* ===== Logic ===== */
const hall=document.getElementById("hall");
const selected=new Map();
let taken=new Set();

function priceParter(r){return r<=6?200:r<=12?160:140}

function update(){
  const a=[...selected.keys()];
  document.getElementById("list").textContent=a.length?a.join(", "):"—";
  const s=[...selected.values()].reduce((x,y)=>x+y,0);
  document.getElementById("sum").textContent="Сума: "+s+" грн";
  document.getElementById("sell").disabled=!a.length;
}

function seat(id,price,cls){
  const b=document.createElement("button");
  b.className="seat "+cls;
  b.textContent=id.split("-")[1];
  if(taken.has(id)){b.classList.add("taken");b.disabled=true}
  b.onclick=()=>{
    if(b.classList.toggle("sel")) selected.set(id,price);
    else selected.delete(id);
    update();
  };
  return b;
}

/* ===== Render ===== */
function renderParter(){
  hall.innerHTML+=`<div class="section">ПАРТЕР</div>`;
  const wrap=document.createElement("div");
  wrap.className="parter-wrap";

  const lodgeA=document.createElement("div");
  lodgeA.className="lodge";
  lodgeA.innerHTML=`<div class="lodge-title">Ложа А</div>`;
  for(let i=1;i<=18;i++)
    lodgeA.append(seat(`A0-M${i}`,10,"lodge-seat"));

  const lodgeB=document.createElement("div");
  lodgeB.className="lodge";
  lodgeB.innerHTML=`<div class="lodge-title">Ложа Б</div>`;
  for(let i=1;i<=18;i++)
    lodgeB.append(seat(`B0-M${i}`,10,"lodge-seat"));

  const rows=document.createElement("div");
  rows.className="rows";

  for(let r=1;r<=18;r++){
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`<div class="row-label">${r}</div>`;
    const s=document.createElement("div");
    s.className="seats";
    for(let m=1;m<=20;m++){
      const cls=(r<=6?"front":r<=12?"mid":"back")+(m===10?" gap":"");
      s.append(seat(`P${r}-M${m}`,priceParter(r),cls));
    }
    row.append(s);rows.append(row);
  }

  wrap.append(lodgeA,rows,lodgeB);
  hall.append(wrap);
}

function renderAmphi(){
  hall.innerHTML+=`<div class="section">АМФІТЕАТР</div>`;
  for(let r=19;r<=23;r++){
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`<div class="row-label">${r}</div>`;
    const s=document.createElement("div");
    s.className="seats";
    for(let m=1;m<=22;m++){
      if(m===12){const g=document.createElement("div");g.className="center-gap";s.append(g);continue;}
      s.append(seat(`A${r}-M${m}`,120,"amphi"));
    }
    row.append(s);hall.append(row);
  }
}

function renderBalcony(){
  hall.innerHTML+=`<div class="section">БАЛКОН</div>`;
  for(let r=1;r<=6;r++){
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`<div class="row-label">${r}</div>`;
    const s=document.createElement("div");
    s.className="seats";
    for(let m=1;m<=28;m++){
      if(r===6 && m>10 && m<19){s.append(document.createElement("div"));continue;}
      if(m===14){const g=document.createElement("div");g.className="center-gap";s.append(g);}
      s.append(seat(`B${r}-M${m}`,r===6?80:100,"balcony"));
    }
    row.append(s);hall.append(row);
  }
}

/* ===== Init ===== */
(async()=>{
  taken=new Set(await getTaken());
  renderParter();
  renderAmphi();
  renderBalcony();
})();

document.getElementById("sell").onclick=async()=>{
  for(const k of selected.keys()) await saveTaken(k);
  alert("Продаж зафіксовано локально");
  location.reload();
};
</script>
</body>
</html>
